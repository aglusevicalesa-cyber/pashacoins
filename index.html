<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>PashaCoin — Clicker</title>
<style>
  :root{
    --bg1:#071022; --bg2:#2a173a;
    --accent1:#ffd55a; --accent2:#ff8b5a;
    --glass: rgba(255,255,255,0.03);
    --muted:#9db0c8;
    --radius:14px;
    --max-width:420px; /* optimized for mobile portrait (Telegram WebApp) */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#eef2f8; display:flex; justify-content:center; align-items:flex-start; padding:12px;}
  .frame {
    width:100%;
    max-width:var(--max-width);
    min-height:100vh;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
    border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,0.6);
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    overflow:hidden;
  }

  /* Header */
  .header {display:flex;align-items:center;justify-content:space-between;gap:8px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:#111;font-weight:900;font-size:18px}
  .title-row{line-height:1}
  .title{font-weight:900;font-size:16px}
  .subtitle{font-size:11px;color:var(--muted)}

  /* Main layout (stacked for portrait) */
  .main {display:flex;flex-direction:column;gap:10px; align-items:center;}

  /* coin button */
  .coin-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
  .coin-button{width:220px;height:220px;border-radius:50%;border:none;background: radial-gradient(circle at 30% 30%, #fff8dc 0%, #ffd55a 22%, #f59b1f 65%); box-shadow:0 18px 44px rgba(220,140,10,0.16), inset 0 -8px 40px rgba(0,0,0,0.08); cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:900; color:#111; font-size:18px; transition:transform .08s}
  .coin-button:active{transform:scale(.97)}
  .stats{width:100%;display:flex;gap:8px;justify-content:space-between}
  .stat{flex:1;background:var(--glass);padding:8px;border-radius:10px;text-align:center}
  .stat h4{margin:0;font-size:11px;color:var(--muted)}
  .stat p{margin:6px 0 0 0;font-weight:900;font-size:16px;color:#fff}

  /* Tabs */
  .tabs{display:flex;gap:6px;width:100%}
  .tab-btn{flex:1;padding:8px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-weight:800;cursor:pointer;font-size:13px}
  .tab-btn.active{background:linear-gradient(90deg, rgba(255,213,90,0.12), rgba(255,140,80,0.06)); color:#fff; border:none; box-shadow:0 8px 20px rgba(255,150,40,0.06)}

  .panel{width:100%;padding:8px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03)); max-height:44vh; overflow:auto}
  .panel.small{max-height:26vh}

  /* Shop grid */
  .shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .shop-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .shop-item .img{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:#111;font-weight:900;font-size:18px;overflow:hidden}
  .shop-meta{flex:1;text-align:left}
  .shop-meta h3{margin:0;font-size:13px}
  .shop-meta p{margin:6px 0 0 0;color:var(--muted);font-size:11px}
  .shop-action{display:flex;flex-direction:column;gap:6px;align-items:center}
  .buy-btn{padding:8px 10px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent1),#ffb24a);color:#111;font-weight:900;font-size:12px}
  .buy-btn[disabled]{opacity:.5;cursor:not-allowed}

  /* Inventory */
  .inv-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .inv-item{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);font-size:12px}

  /* Tasks */
  .task{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .small-note{color:var(--muted);font-size:12px;text-align:center;margin-top:6px}

  /* responsive adjustments */
  @media (max-width:420px){
    .coin-button{width:180px;height:180px;font-size:16px}
    .shop-grid{grid-template-columns:1fr}
    .inv-grid{grid-template-columns:repeat(4,1fr)}
  }
</style>
</head>
<body>
  <div class="frame" role="application" id="app">
    <div class="header">
      <div class="brand">
        <div class="logo">PC</div>
        <div class="title-row">
          <div class="title">PashaCoin</div>
          <div class="subtitle">Clicker — beta</div>
        </div>
      </div>
      <a id="tgLink" href="#" target="_blank" style="color:#9be7ff;font-weight:800;text-decoration:none">@pleshsup</a>
    </div>

    <div class="main">
      <div class="coin-wrap">
        <button id="coinBtn" class="coin-button" aria-label="PashaCoin button">
          <div>
            <div style="font-weight:900">PashaCoin</div>
            <div style="font-size:12px;color:#222;font-weight:800">Тапни!</div>
          </div>
        </button>

        <div class="stats" style="width:100%;max-width:360px;">
          <div class="stat"><h4>Баланс</h4><p id="coinsDisplay">0</p></div>
          <div class="stat"><h4>За клик</h4><p id="perClick">+1</p></div>
        </div>
      </div>

      <div class="tabs" style="width:100%">
        <button class="tab-btn active" data-tab="shop">Магазин</button>
        <button class="tab-btn" data-tab="inventory">Инвентарь</button>
        <button class="tab-btn" data-tab="daily">Ежедневные</button>
        <button class="tab-btn" data-tab="ref">Рефералы</button>
      </div>

      <!-- Panels -->
      <div id="shop" class="panel">
        <div class="shop-grid" id="shopGrid"></div>
        <div class="small-note">Нажми «Купить», чтобы приобрести предмет. Купленное попадёт в Инвентарь.</div>
      </div>

      <div id="inventory" class="panel" style="display:none">
        <h3 style="margin:6px 0 10px 0">Инвентарь</h3>
        <div class="inv-grid" id="invGrid"></div>
        <div class="small-note">Купленные предметы сохраняются локально (localStorage).</div>
      </div>

      <div id="daily" class="panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>День в цепочке:</strong> <span id="streakDay">0</span>/30</div>
          <div><strong>Награда:</strong> <span id="dailyReward">—</span></div>
        </div>
        <div style="margin-top:8px"><button class="buy-btn" onclick="claimDaily()">Забрать ежедневную награду</button></div>
        <h4 style="margin-top:10px">Задания на сегодня</h4>
        <div id="tasksList"></div>
      </div>

      <div id="ref" class="panel" style="display:none">
        <h3 style="margin:6px 0">Реферальная система</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="refInput" class="ref-input" readonly style="flex:1;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:#fff"/>
          <button id="copyBtn" class="buy-btn">Скопировать</button>
        </div>
        <div style="margin-top:8px" class="small-note">При переходе по ссылке ?ref=твой_username приглашённый получит +1000 PashaCoin при первом входе.</div>
        <h4 style="margin-top:12px">Локальные приглашённые</h4>
        <div id="leaderboard"></div>
      </div>

    </div> <!-- main -->

    <footer style="text-align:center;color:var(--muted);font-size:12px;padding-top:6px">Локальная версия — прогресс хранится в браузере.</footer>
  </div>

<script>
/* ========= boot / compatibility with Telegram WebApp ========= */
let tg = null;
if(window.Telegram && window.Telegram.WebApp){
  try{
    tg = window.Telegram.WebApp;
    // expand the webapp inside Telegram (mobile)
    try { tg.expand(); } catch(e){ /* ignore */ }
  }catch(e){}
}

/* ========= Utilities ========= */
const $ = id => document.getElementById(id);
const nowSec = ()=> Math.floor(Date.now()/1000);
const saveKey = 'pashastate_v1';

/* ========= Default state ========= */
const defaults = {
  coins: 0,
  perClick: 1,
  multiplier: 1,
  auto: { enabled:false, interval:3, amount:1 },
  lastSeen: nowSec(),
  ownerUsername: "",
  referredBy: null,
  invited: [],
  purchases: {}, // {itemId: true}
  daily:{
    lastClaimDay: 0,
    streak: 0,
    history: [], // ids of tasks for recent days
    tasksSeed: null,
    tasksToday: null
  }
};

/* ========= Load/Save ========= */
function loadState(){
  try{
    const raw = localStorage.getItem(saveKey) || '{}';
    const parsed = JSON.parse(raw);
    return Object.assign({}, defaults, parsed);
  }catch(e){
    return Object.assign({}, defaults);
  }
}
function saveState(){
  try{
    localStorage.setItem(saveKey, JSON.stringify(state));
  }catch(e){
    console.warn("Save failed", e);
  }
}

/* ========= App state ========= */
let state = loadState();

/* ========= UI refs ========= */
const coinBtn = $('coinBtn'), coinsDisplay = $('coinsDisplay'), perClickEl = $('perClick'), lastSeenEl = $('lastSeen'), floatingContainer = $('floatingContainer');
const shopGrid = $('shopGrid'), invGrid = $('invGrid'), tasksList = $('tasksList'), streakDayEl = $('streakDay'), dailyRewardEl = $('dailyReward');
const refInput = $('refInput'), copyBtn = $('copyBtn'), leaderboardEl = $('leaderboard');

/* ========= Sound ========= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function playTone(freq=880,dur=0.06,type='sine',gain=0.06){
  if(!AudioCtx) return;
  if(!audioCtx) audioCtx = new AudioCtx();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=gain;
  o.connect(g); g.connect(audioCtx.destination); o.start();
  setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, dur*1000);
}
function playClick(){ playTone(900,0.05,'sine',0.06) }
function playBuy(){ playTone(520,0.09,'triangle',0.08); playTone(820,0.06,'sine',0.05) }
function playOffline(){ playTone(320,0.12,'sine',0.08) }

/* ========= Helper UI functions ========= */
function showToast(text, timeout=1300){
  const el = document.createElement('div');
  el.textContent = text;
  el.style.position='fixed';
  el.style.left='50%';
  el.style.bottom='18px';
  el.style.transform='translateX(-50%)';
  el.style.padding='10px 14px';
  el.style.background='rgba(0,0,0,0.6)';
  el.style.color='#fff';
  el.style.borderRadius='10px';
  el.style.zIndex=9999;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), timeout);
}

/* Floating +N effect (small) */
function showFloating(x,y,text){
  const el = document.createElement('div'); el.className='floating'; el.style.left = x+'px'; el.style.top = y+'px'; el.textContent = text;
  el.style.position='absolute';
  el.style.pointerEvents='none';
  el.style.fontWeight='900';
  el.style.color='#fff7e6';
  el.style.textShadow='0 6px 20px rgba(0,0,0,0.45)';
  el.style.fontSize='14px';
  el.style.transform='translate(-50%,0)';
  el.style.transition='transform 0.9s ease, opacity 0.9s ease';
  floatingContainer.appendChild(el);
  requestAnimationFrame(()=> {
    el.style.transform='translate(-50%,-110px)';
    el.style.opacity='0';
  });
  setTimeout(()=> el.remove(),950);
}

/* ========= Shop items (100 auto-generated, nicer names) ========= */
const baseIcons = [
  "🪙","🔰","⚡","💎","🎯","🛡️","⚒️","🎩","🐭","🚀"
];

function makeShopList(){
  const list = [];
  for(let i=1;i<=100;i++){
    const tier = Math.floor((i-1)/10)+1;
    const price = Math.round((10 + (i-1)*12) * Math.pow(1.04, tier));
    const name = [
      "Золотой мышонок","Кликер MK."+i,"Сундук удачи","Эмблема ветра","Молот Фортуны",
      "Нагрудник развития","Пушистый амулет","Кольцо богатства","Турбо-курок","Портал XP"
    ][(i-1)%10] + (tier>1?` Mk${tier}`:'');
    const img = `https://via.placeholder.com/160x160.png?text=I${i}`; // placeholder
    const icon = baseIcons[(i-1)%baseIcons.length];
    list.push({id:`itm${i}`, title:name, desc:`Уникальный предмет ${i}`, price, img, icon});
  }
  return list;
}
const shopItems = makeShopList();

/* ========= Render functions ========= */
function render(){
  coinsDisplay.textContent = state.coins;
  perClickEl.textContent = '+' + (state.perClick * state.multiplier);
  lastSeenEl && (lastSeenEl.textContent = new Date(state.lastSeen*1000).toLocaleString());
  refInput.value = location.origin + location.pathname + '?ref=' + (state.ownerUsername || 'pleshsup');

  renderShop();
  renderInventory();
  renderDaily();
  renderLeaderboard();
  saveState();
}

function renderShop(){
  shopGrid.innerHTML = '';
  shopItems.forEach(item=>{
    const el = document.createElement('div');
    el.className = 'shop-item';
    const bought = !!state.purchases[item.id];
    el.innerHTML = `
      <div class="img"><img src="${item.img}" alt="" style="width:100%;height:100%;object-fit:cover"/></div>
      <div class="shop-meta"><h3>${item.icon} ${item.title}</h3><p>${item.desc}</p></div>
      <div class="shop-action"><div style="color:var(--muted);font-weight:900">${item.price} 💰</div>
      <button class="buy-btn" data-id="${item.id}" ${bought?'disabled':''}>${bought?'Куплено':'Купить'}</button></div>
    `;
    shopGrid.appendChild(el);
  });
  // delegate click handlers
  shopGrid.querySelectorAll('.buy-btn').forEach(b=>{
    b.addEventListener('click',()=> buyById(b.dataset.id));
  });
}

function renderInventory(){
  invGrid.innerHTML = '';
  const keys = Object.keys(state.purchases);
  if(keys.length===0){
    invGrid.innerHTML = '<div style="width:100%;text-align:center;color:var(--muted)">Инвентарь пуст</div>';
    return;
  }
  keys.forEach(pid=>{
    const item = shopItems.find(s=>s.id===pid);
    if(!item) return;
    const el = document.createElement('div');
    el.className = 'inv-item';
    el.innerHTML = `<div style="width:56px;height:56px;border-radius:10px;overflow:hidden"><img src="${item.img}" style="width:100%;height:100%;object-fit:cover"></div><div style="font-size:12px">${item.title}</div>`;
    invGrid.appendChild(el);
  });
}

/* ========= Buy logic ========= */
function buyById(id){
  const item = shopItems.find(s=>s.id===id);
  if(!item) return;
  if(state.purchases[item.id]){
    showToast("Уже куплено");
    return;
  }
  if(state.coins < item.price){
    showToast("Недостаточно PashaCoin");
    return;
  }
  // subtract
  state.coins -= item.price;
  state.purchases[item.id] = { boughtAt: nowSec(), id: item.id };
  // optionally apply slight bonuses for some items (demo)
  // e.g., if id ends with 5 -> increase perClick
  if(item.id.endsWith('5')) {
    state.perClick += 1;
    showToast("За покупку +1 клик!");
  }
  playBuy();
  render();
  // notify Telegram bot if inside webapp
  if(tg && tg.sendData){
    try{ tg.sendData(JSON.stringify({type:'purchase', itemId:item.id, title:item.title, price:item.price})); }catch(e){}
  }
  alert('Куплено: '+item.title);
}

/* ========= Inventory / purchases persisted by state.purchases ========= */
function renderLeaderboard(){
  leaderboardEl.innerHTML = '';
  const list = state.invited || [];
  if(list.length===0){
    leaderboardEl.innerHTML = '<div style="color:var(--muted)">Пока нет локально приглашённых.</div>';
    return;
  }
  list.slice(-10).reverse().forEach(u=>{
    const el = document.createElement('div');
    el.className='leader';
    el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.style.padding='6px'; el.style.borderRadius='8px';
    el.style.background='rgba(255,255,255,0.02)';
    el.innerHTML = `<div style="width:36px;height:36px;border-radius:8px;overflow:hidden"><img src="${u.avatar||'https://via.placeholder.com/48'}" style="width:100%;height:100%;object-fit:cover"></div>
      <div style="flex:1"><div style="font-weight:800">${u.username||u.id}</div><div style="color:var(--muted);font-size:12px">${new Date(u.at*1000).toLocaleString()}</div></div>
      <a href="https://t.me/${u.username||''}" target="_blank" style="color:#9be7ff;font-weight:800;text-decoration:none">@${u.username||u.id}</a>`;
    leaderboardEl.appendChild(el);
  });
}

/* ========= Daily tasks system (generate pool 150, pick 5/day) ========= */
const tasksPool = (function(){
  const templates = [
    {text:'Сделай {N} кликов', type:'clicks', baseN:[20,50,80]},
    {text:'Заработай {N} PashaCoin за сессию', type:'earn', baseN:[100,300,500]},
    {text:'Сделай {N} кликов за {T} секунд', type:'speed', baseN:[20,50], time:[10,20]},
    {text:'Проведи в игре {M} минут', type:'time', baseN:[1,3,5]},
    {text:'Купи любую прокачку', type:'buyAny'},
    {text:'Купи апгрейд за {N} монет', type:'buyFor', baseN:[100,500,2000]},
    {text:'Пригласи друга (реф)', type:'invite'},
    {text:'Собери {N} монет за день', type:'collectDay', baseN:[500,1000,2500]},
    {text:'Выполни {K} простых заданий сегодня', type:'completeSimple', baseN:[1,2,3]},
    {text:'Сделай {N} кликов подряд (секундный лимит)', type:'streak', baseN:[50,100], time:[20,40]}
  ];
  const pool = [];
  function choose(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  let idCounter = 1;
  while(pool.length < 150){
    const t = choose(templates);
    let text='', id = 't'+idCounter, reward=0, meta={};
    if(t.type==='clicks'){
      const N = choose(t.baseN);
      text = t.text.replace('{N}',N);
      reward = Math.round(N*2.5);
      meta = {type:'clicks', need:N, progress:0};
    } else if(t.type==='earn'){
      const N = choose(t.baseN);
      text = t.text.replace('{N}',N);
      reward = Math.round(N*0.5);
      meta = {type:'earn', need:N, progress:0};
    } else if(t.type==='speed'){
      const N = choose(t.baseN); const T = choose(t.time);
      text = t.text.replace('{N}',N).replace('{T}',T);
      reward = Math.round(N*3);
      meta = {type:'speed', need:N, time:T, progress:0, startedAt:null};
    } else if(t.type==='time'){
      const M = choose(t.baseN);
      text = t.text.replace('{M}',M);
      reward = Math.round(M*40);
      meta = {type:'time', need:M*60, progress:0, enteredAt:null};
    } else if(t.type==='buyAny'){
      text = t.text;
      reward = 300;
      meta = {type:'buyAny', done:false};
    } else if(t.type==='buyFor'){
      const N = choose(t.baseN);
      text = t.text.replace('{N}',N);
      reward = Math.round(N*0.6);
      meta = {type:'buyFor', price:N, done:false};
    } else if(t.type==='invite'){
      text = t.text;
      reward = 1000;
      meta = {type:'invite', done:false};
    } else if(t.type==='collectDay'){
      const N = choose(t.baseN);
      text = t.text.replace('{N}',N);
      reward = Math.round(N*0.3);
      meta = {type:'collectDay', need:N, progress:0};
    } else if(t.type==='completeSimple'){
      const K = choose(t.baseN);
      text = t.text.replace('{K}',K);
      reward = 250*K;
      meta = {type:'completeSimple', need:K, progress:0};
    } else if(t.type==='streak'){
      const N = choose(t.baseN); const T = choose(t.time);
      text = t.text.replace('{N}',N).replace('{T}',T);
      reward = Math.round(N*4);
      meta = {type:'streak', need:N, time:T, progress:0, startedAt:null};
    }
    if(!pool.some(x=>x.text===text)){
      pool.push({id, text, reward, meta});
      idCounter++;
    }
  }
  return pool;
})();

function getTodayTasks(){
  const seed = state.daily.tasksSeed || Math.floor(Math.random()*1e9);
  if(!state.daily.tasksSeed) state.daily.tasksSeed = seed;
  const lastWeek = state.daily.history || [];
  const pool = tasksPool.filter(t => !lastWeek.includes(t.id));
  // deterministic-ish shuffle using seed:
  for(let i=pool.length-1;i>0;i--){
    const j = Math.floor(Math.abs(Math.sin(seed + i) * 1000000) % (i+1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  const selected = pool.slice(0,5);
  state.daily.tasksToday = selected.map(t=>JSON.parse(JSON.stringify(t)));
  return state.daily.tasksToday;
}

function renderDaily(){
  streakDayEl.textContent = state.daily.streak;
  dailyRewardEl.textContent = (() => {
    const idx = Math.max(0, Math.min(29, state.daily.streak-1));
    if(idx < 0) return 0;
    return (() => {
      const arr = [];
      let base = 50;
      for(let i=1;i<=30;i++){
        if(i<=7) base = 50 * i;
        else if(i<=14) base = 400 + (i-7)*150;
        else if(i<=21) base = 1500 + (i-14)*400;
        else if(i<=27) base = 5000 + (i-21)*1500;
        else base = 20000 + (i-27)*10000;
        arr.push(base);
      }
      return arr[idx] || 0;
    })();
  })();

  if(!state.daily.tasksToday || state.daily.tasksSeed === null) getTodayTasks();
  tasksList.innerHTML = '';
  (state.daily.tasksToday||[]).forEach(task => {
    const div = document.createElement('div');
    div.className = 'task';
    const done = isTaskDone(task.id);
    div.innerHTML = `<div style="flex:1;text-align:left"><strong>${task.text}</strong><div style="color:var(--muted);font-size:12px">Награда: ${task.reward} PashaCoin</div></div>
      <div><button class="buy-btn" data-task="${task.id}">${done?'Готово':'Выполнить'}</button></div>`;
    tasksList.appendChild(div);
  });
  // attach listeners
  tasksList.querySelectorAll('.buy-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.dataset.task;
      const t = (state.daily.tasksToday||[]).find(x=>x.id===id);
      if(!t) return;
      // for demo: mark some types done
      t.meta.done = true;
      state.coins += t.reward;
      saveState();
      render();
      alert(`Награда получена: +${t.reward} PashaCoin`);
    });
  });
}

/* helper: basic task checking (client-side) */
function isTaskDone(id){
  const t = (state.daily.tasksToday||[]).find(x=>x.id===id);
  if(!t) return false;
  if(t.meta.type==='buyAny') return !!t.meta.done;
  if(t.meta.type==='buyFor') return !!t.meta.done;
  if(t.meta.type==='invite') return !!t.meta.done;
  if(t.meta.type==='clicks') return (t.meta.progress||0) >= t.meta.need;
  if(t.meta.type==='earn') return (t.meta.progress||0) >= t.meta.need;
  return !!t.meta.done;
}

/* update click progress for tasks */
function updateTaskProgressOnClick(){
  const todays = state.daily.tasksToday || [];
  todays.forEach(t=>{
    if(t.meta.type==='clicks'){
      t.meta.progress = (t.meta.progress||0) + 1;
      if(t.meta.progress >= t.meta.need && !t.meta.done){
        t.meta.done = true;
        state.coins += t.reward;
        showToast('Задание выполнено: +'+t.reward+' PashaCoin');
      }
    }
    if(t.meta.type==='earn'){
      t.meta.progress = (t.meta.progress||0) + (state.perClick * state.multiplier);
      if(t.meta.progress >= t.meta.need && !t.meta.done){
        t.meta.done = true;
        state.coins += t.reward;
        showToast('Задание выполнено: +'+t.reward+' PashaCoin');
      }
    }
  });
  saveState();
}

/* claim daily */
function getDayIndex(){ return Math.floor(Date.now()/1000/86400); }
function claimDaily(){
  const today = getDayIndex();
  if(state.daily.lastClaimDay === today){
    alert('Ежедневная награда уже получена сегодня.');
    return;
  }
  if(state.daily.lastClaimDay === today-1) state.daily.streak = Math.min(30, state.daily.streak+1); else state.daily.streak = 1;
  const reward = (function(){
    const i = Math.max(0, Math.min(29, state.daily.streak-1));
    const arr = [];
    let base=50;
    for(let k=1;k<=30;k++){
      if(k<=7) base = 50*k;
      else if(k<=14) base = 400 + (k-7)*150;
      else if(k<=21) base = 1500 + (k-14)*400;
      else if(k<=27) base = 5000 + (k-21)*1500;
      else base = 20000 + (k-27)*10000;
      arr.push(base);
    }
    return arr[i]||0;
  })();
  state.coins += reward;
  state.daily.lastClaimDay = today;
  state.daily.history = state.daily.history || [];
  const todayIds = (state.daily.tasksToday||[]).map(t=>t.id);
  state.daily.history.push(...todayIds);
  state.daily.history = state.daily.history.slice(-21*5);
  state.daily.tasksSeed = null; state.daily.tasksToday = null;
  playBuy();
  render();
  alert('Награда получена: +' + reward + ' PashaCoin');
}

/* ========= Auto clicker ========= */
let autoTimer = null;
function startAuto(){
  if(!state.auto.enabled) return;
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(()=>{ state.coins += state.auto.amount; render(); }, state.auto.interval*1000);
}
if(state.auto && state.auto.enabled) startAuto();

/* ========= Referral handling ========= */
function handleReferral(){
  const params = new URLSearchParams(location.search);
  if(params.has('ref')){
    const ref = params.get('ref');
    // block self-referral
    if(state.ownerUsername && state.ownerUsername.toLowerCase() === ref.toLowerCase()) { console.log('self-ref blocked'); return; }
    if(!state.referredBy){
      state.referredBy = ref;
      state.coins += 1000;
      state.invited = state.invited || [];
      state.invited.push({ username: ref, at: nowSec() });
      saveState();
      playOffline();
      alert('Бонус: +1000 PashaCoin за приглашение от @' + ref);
    }
  }
}
handleReferral();

/* copy referral */
copyBtn.addEventListener('click', ()=>{
  if(!state.ownerUsername){
    const name = prompt('Введите ваш Telegram username (без @):');
    if(!name) return alert('Нужно указать username');
    state.ownerUsername = name.trim(); saveState();
  }
  const link = location.origin + location.pathname + '?ref=' + encodeURIComponent(state.ownerUsername);
  navigator.clipboard?.writeText(link).then(()=>{ copyBtn.textContent='Скопировано!'; setTimeout(()=>copyBtn.textContent='Скопировать',1400); }).catch(()=>{ prompt('Скопируй ссылку вручную', link); });
});

/* ========= Click handling (main button) ========= */
coinBtn.addEventListener('click', (e)=>{
  const gained = state.perClick * state.multiplier;
  state.coins += gained;
  updateTaskProgressOnClick();
  render();
  // floating effect center of button
  const rect = coinBtn.getBoundingClientRect();
  const cx = rect.left + rect.width/2 - (appRectLeft || 0);
  showFloating(rect.left + rect.width/2 - document.body.getBoundingClientRect().left, rect.top - document.body.getBoundingClientRect().top, '+'+gained);
  playClick();
});

/* compute appRectLeft for floating alignment */
let appRectLeft = document.getElementById('app').getBoundingClientRect().left;

/* ========= Tabs behavior ========= */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
    $(tab).style.display = 'block';
  });
});

/* ========= Misc helpers ========= */
function resetProgress(){
  if(!confirm('Сбросить локальный прогресс?')) return;
  localStorage.removeItem(saveKey);
  location.reload();
}

/* attach settings changes (if any) */
// (no settings inputs in compact version other than copy ref)

/* initial render */
render();

/* expose for debug */
window._pasha = { state, shopItems, tasksPool };

/* handle window resize to recompute positions */
window.addEventListener('resize', ()=>{ appRectLeft = document.getElementById('app').getBoundingClientRect().left; });

/* remove noisy alerts in Telegram (optional) */
if(tg && tg.ready) try{ tg.ready(); }catch(e){}

</script>
</body>
</html>
